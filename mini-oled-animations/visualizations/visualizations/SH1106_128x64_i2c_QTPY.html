<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>128x64 OLED Display Simulator - Graphics Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
        }
        canvas {
            border: 2px solid black;
            background-color: black;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        h1, h2 {
            color: #333;
        }
    </style>
</head>
<body>
    <div>
        <button onclick="togglePause()">Pause/Resume</button>
        <button onclick="resetAnimation()">Reset</button>
    </div>
    <div>
        <canvas id="oledCanvas" width="128" height="64" style="width: 256px; height: 128px;"></canvas>
    </div>
    <h1>128x64 OLED Display Simulator</h1>
    <h2>Graphics and Text Demo</h2>

    <script>
        const canvas = document.getElementById('oledCanvas');
        const ctx = canvas.getContext('2d');
        const scale = 2;
        canvas.style.width = `${128 * scale}px`;
        canvas.style.height = `${64 * scale}px`;
        let isPaused = false;
        let currentTest = 0;
        let testStartTime = 0;
        const testDuration = 2000;
        let bitmapIcons = [];
        const NUMFLAKES = 10;
        const LOGO_WIDTH = 16;
        const LOGO_HEIGHT = 16;
        let animationFrameId;

        const logo16_glcd_bmp = [
            0b0000000011000000,
            0b0000000111000000,
            0b0000000111000000,
            0b0000001111100000,
            0b1111001111100000,
            0b1111111011111000,
            0b0111111011111111,
            0b0011001110011111,
            0b0001111111111100,
            0b0000110101110000,
            0b0001101110100000,
            0b0011111111100000,
            0b0011111111110000,
            0b0111110011110000,
            0b0111000001110000,
            0b0000000000110000
        ];

        function initBitmapIcons() {
            bitmapIcons = [];
            for (let f = 0; f < NUMFLAKES; f++) {
                bitmapIcons.push({
                    x: Math.floor(Math.random() * 128),
                    y: 0,
                    dy: Math.floor(Math.random() * 5) + 1
                });
            }
        }

        function clearDisplay() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, 128, 64);
        }

        function drawPixel(x, y, color) {
            ctx.fillStyle = color === 1 ? 'white' : 'black';
            ctx.fillRect(x, y, 1, 1);
        }

        function drawLine(x0, y0, x1, y1, color) {
            ctx.beginPath();
            ctx.strokeStyle = color === 1 ? 'white' : 'black';
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        }

        function drawRect(x, y, w, h, color) {
            ctx.strokeStyle = color === 1 ? 'white' : 'black';
            ctx.strokeRect(x, y, w, h);
        }

        function fillRect(x, y, w, h, color) {
            ctx.fillStyle = color === 1 ? 'white' : 'black';
            ctx.fillRect(x, y, w, h);
        }

        function drawCircle(x, y, r, color) {
            ctx.beginPath();
            ctx.strokeStyle = color === 1 ? 'white' : 'black';
            ctx.arc(x, y, r, 0, 2 * Math.PI);
            ctx.stroke();
        }

        function fillCircle(x, y, r, color) {
            ctx.beginPath();
            ctx.fillStyle = color === 1 ? 'white' : 'black';
            ctx.arc(x, y, r, 0, 2 * Math.PI);
            ctx.fill();
        }

        function drawTriangle(x1, y1, x2, y2, x3, y3, color) {
            ctx.beginPath();
            ctx.strokeStyle = color === 1 ? 'white' : 'black';
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x3, y3);
            ctx.closePath();
            ctx.stroke();
        }

        function fillTriangle(x1, y1, x2, y2, x3, y3, color) {
            ctx.beginPath();
            ctx.fillStyle = color === 1 ? 'white' : 'black';
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x3, y3);
            ctx.closePath();
            ctx.fill();
        }

        function drawRoundRect(x, y, w, h, r, color) {
            ctx.beginPath();
            ctx.strokeStyle = color === 1 ? 'white' : 'black';
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.arcTo(x + w, y, x + w, y + r, r);
            ctx.lineTo(x + w, y + h - r);
            ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
            ctx.lineTo(x + r, y + h);
            ctx.arcTo(x, y + h, x, y + h - r, r);
            ctx.lineTo(x, y + r);
            ctx.arcTo(x, y, x + r, y, r);
            ctx.closePath();
            ctx.stroke();
        }

        function fillRoundRect(x, y, w, h, r, color) {
            ctx.beginPath();
            ctx.fillStyle = color === 1 ? 'white' : 'black';
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.arcTo(x + w, y, x + w, y + r, r);
            ctx.lineTo(x + w, y + h - r);
            ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
            ctx.lineTo(x + r, y + h);
            ctx.arcTo(x, y + h, x, y + h - r, r);
            ctx.lineTo(x, y + r);
            ctx.arcTo(x, y, x + r, y, r);
            ctx.closePath();
            ctx.fill();
        }

        function drawText(x, y, text, size, color, bgColor = null) {
            ctx.font = `${size * 8}px monospace`;
            ctx.fillStyle = color === 1 ? 'white' : 'black';
            if (bgColor !== null) {
                ctx.fillStyle = bgColor === 1 ? 'white' : 'black';
                ctx.fillRect(x, y - size * 8, text.length * size * 6, size * 8);
                ctx.fillStyle = color === 1 ? 'white' : 'black';
            }
            ctx.fillText(text, x, y);
        }

        function drawBitmap(x, y, bitmap, w, h, color) {
            for (let j = 0; j < h; j++) {
                for (let i = 0; i < w; i++) {
                    if (bitmap[j] & (1 << (15 - i))) {
                        drawPixel(x + i, y + j, color);
                    }
                }
            }
        }

        function testdrawline(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 10) % 512;
            clearDisplay();
            if (i < 128) {
                drawLine(0, 0, i, 63, 1);
            } else if (i < 192) {
                drawLine(0, 0, 127, i - 128, 1);
            } else if (i < 256) {
                drawLine(0, 63, i - 128, 0, 1);
            } else if (i < 320) {
                drawLine(0, 63, 127, 319 - i, 1);
            } else if (i < 384) {
                drawLine(127, 63, 383 - i, 0, 1);
            } else if (i < 448) {
                drawLine(127, 63, 0, 447 - i, 1);
            } else if (i < 512) {
                drawLine(127, 0, 0, i - 448, 1);
            } else {
                drawLine(127, 0, i - 512, 63, 1);
            }
        }

        function testdrawrect(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 40) % 32;
            clearDisplay();
            drawRect(i, i, 128 - 2 * i, 64 - 2 * i, 1);
        }

        function testfillrect(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 60) % 32;
            clearDisplay();
            fillRect(i, i, 128 - 2 * i, 64 - 2 * i, i % 2);
        }

        function testdrawcircle(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 40) % 64;
            clearDisplay();
            drawCircle(64, 32, i, 1);
        }

        function testfillcircle() {
            clearDisplay();
            fillCircle(64, 32, 10, 1);
        }

        function testdrawroundrect(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 40) % 30;
            clearDisplay();
            drawRoundRect(i, i, 128 - 2 * i, 64 - 2 * i, 16, 1);
        }

        function testfillroundrect(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 40) % 30;
            clearDisplay();
            fillRoundRect(i, i, 128 - 2 * i, 64 - 2 * i, 16, i % 2);
        }

        function testdrawtriangle(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 80) % 32;
            clearDisplay();
            drawTriangle(64, 32 - i, 64 - i, 32 + i, 64 + i, 32 + i, 1);
        }

        function testfilltriangle(timestamp) {
            let i = Math.floor((timestamp - testStartTime) / 80) % 32;
            clearDisplay();
            fillTriangle(64, 32 - i, 64 - i, 32 + i, 64 + i, 32 + i, i % 2);
        }

        function testdrawchar() {
            clearDisplay();
            ctx.font = '8px monospace';
            ctx.fillStyle = 'white';
            let i = 0;
            for (let c = 0; c < 168; c++) {
                if (String.fromCharCode(c) !== '\n') {
                    ctx.fillText(String.fromCharCode(c), (i % 21) * 6, Math.floor(i / 21) * 8 + 8);
                    i++;
                }
            }
        }

        function testtext() {
            clearDisplay();
            drawText(0, 8, "Failure is always an option", 1, 1);
            drawText(0, 16, "3.141592", 1, 0, 1);
            drawText(0, 32, "0xDEADBEEF", 2, 1);
        }

        function testdrawbitmap(timestamp) {
            clearDisplay();
            for (let f = 0; f < NUMFLAKES; f++) {
                drawBitmap(bitmapIcons[f].x, bitmapIcons[f].y, logo16_glcd_bmp, LOGO_WIDTH, LOGO_HEIGHT, 1);
                bitmapIcons[f].y += bitmapIcons[f].dy;
                if (bitmapIcons[f].y > 64) {
                    bitmapIcons[f].x = Math.floor(Math.random() * 128);
                    bitmapIcons[f].y = 0;
                    bitmapIcons[f].dy = Math.floor(Math.random() * 5) + 1;
                }
            }
        }

        const tests = [
            () => drawPixel(10, 10, 1),
            testdrawline,
            testdrawrect,
            testfillrect,
            testdrawcircle,
            testfillcircle,
            testdrawroundrect,
            testfillroundrect,
            testdrawtriangle,
            testfilltriangle,
            testdrawchar,
            testtext,
            () => drawBitmap(30, 16, logo16_glcd_bmp, LOGO_WIDTH, LOGO_HEIGHT, 1),
            () => { display.invertDisplay(true); },
            () => { display.invertDisplay(false); },
            testdrawbitmap
        ];

        function animate(timestamp) {
            if (isPaused) {
                animationFrameId = requestAnimationFrame(animate);
                return;
            }

            if (currentTest < tests.length - 1 && timestamp - testStartTime > testDuration) {
                currentTest++;
                testStartTime = timestamp;
                clearDisplay();
            }

            if (currentTest === tests.length - 1 && !bitmapIcons.length) {
                initBitmapIcons();
            }

            if (currentTest === 13) { // Invert display (true)
                ctx.filter = 'invert(1)';
            } else if (currentTest === 14) { // Invert display (false)
                ctx.filter = 'invert(0)';
            } else {
                ctx.filter = 'none';
                tests[currentTest](timestamp);
            }

            animationFrameId = requestAnimationFrame(animate);
        }

        function togglePause() {
            isPaused = !isPaused;
        }

        function resetAnimation() {
            currentTest = 0;
            testStartTime = performance.now();
            isPaused = false;
            bitmapIcons = [];
            clearDisplay();
            ctx.filter = 'none';
        }

        testStartTime = performance.now();
        animationFrameId = requestAnimationFrame(animate);
    </script>
</body>
</html>